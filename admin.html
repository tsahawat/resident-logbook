<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resident Logbook — Admin</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --txt:#e5e7eb; --muted:#9ca3af; }
    body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
    h1{margin:0 0 12px;font-size:22px}
    label{color:var(--muted);margin-right:10px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #334155;padding:8px;text-align:right}
    th:first-child, td:first-child { text-align:left }
    tfoot td{font-weight:700}
    input,select,button{padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:var(--txt)}
    
    /* extra style for download links */
    a#downloadRaw, a#downloadFiltered { 
      cursor: pointer; 
      text-decoration: underline;
      color: var(--acc, #22d3ee); /* optional highlight */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Resident Logbook — Admin</h1>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <label>Year
          <select id="year">
            <option value="">All</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </label>
        <label>Search name <input id="q" placeholder="type to filter" /></label>
        <button id="refresh">Refresh</button>
        <a href="#" id="downloadPivot">Download Pivot CSV</a>
        <a href="#" id="downloadRaw">Download Raw CSV</a>
        <a href="#" id="downloadFiltered">Download Filtered CSV</a>
      </div>
      <div id="stats" style="margin-top:10px;color:var(--muted)"></div>
      <div id="tableWrap"></div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const CSV_URL = 'https://script.google.com/macros/s/AKfycbz1mgE0WGLqe6qHLOXuhHJdamkZ4Pa_bm-wBLYFDyuFeLXBGDq_fyq3aePU8ffjTmXD/exec?mode=csv';
  const PROC_ORDER = [
    'Case attending',
    'Endotracheal tube insertion',
    'Laryngeal mask airway insertion',
    'Arterial line insertion',
    'Central venous pressure insertion',
    'Brachial plexus block',
    'Lower limb blocks',
    'Spinal block',
    'Epidural block',
    'Painless labour'
  ];

  const yearSel = document.getElementById('year');
  const qEl = document.getElementById('q');
  const tableWrap = document.getElementById('tableWrap');
  const statsEl = document.getElementById('stats');
  document.getElementById('refresh').addEventListener('click', load);
  yearSel.addEventListener('change', render);
  qEl.addEventListener('input', render);

document.getElementById('downloadPivot').addEventListener('click', (e) => {
  e.preventDefault();
  if (!lastPivot.length) { 
    alert('No data loaded yet. Click Refresh first.'); 
    return; 
  }
  const pivotCsv = toCsv(lastPivot);
  downloadText(pivotCsv, `resident-logbook-pivot_${ts()}.csv`);
});
  
document.getElementById('downloadRaw').addEventListener('click', (e) => {
  e.preventDefault();
  if (!lastCsv) { 
    alert('No CSV loaded yet. Click Refresh first.'); 
    return; 
  }
  downloadText(lastCsv, `resident-logbook-raw_${ts()}.csv`);
});

document.getElementById('downloadFiltered').addEventListener('click', (e) => {
  e.preventDefault();
  if (!lastFiltered.length) { 
    alert('No data loaded yet. Click Refresh first.'); 
    return; 
  }
  const filteredCsv = toCsv(lastFiltered);
  downloadText(filteredCsv, `resident-logbook-filtered_${ts()}.csv`);
});
  
  let rows = []; // parsed CSV
  let lastCsv = '';     // raw CSV text from server
  let lastFiltered = []; // filtered rows (array of arrays)
  let lastPivot = [];     // NEW: pivot table 2D array for download
  load();

  async function load(){
    tableWrap.innerHTML = 'Loading…';
    try{
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      const text = await res.text();
      lastCsv = text;
      rows = parseCsv(text);
      render();
    }catch(err){ tableWrap.innerHTML = 'Error loading CSV: '+String(err); }
  }

function render(){
  if (!rows.length){ tableWrap.innerHTML = 'No data'; return; }

  const [hdr, ...data] = rows;
  const idx = Object.fromEntries(hdr.map((h,i)=>[h,i]));

  const yearFilter = yearSel.value.trim();
  const q = qEl.value.trim().toLowerCase();

  const filtered = data.filter(r => {
    const yearOk = !yearFilter || r[idx.ResidentYear] === yearFilter;
    const nameOk = !q || (r[idx.FullName]||'').toLowerCase().includes(q);
    return yearOk && nameOk;
  });

  // Keep filtered rows (for “Download Filtered CSV”)
  lastFiltered = [hdr, ...filtered];

  // Build pivot by FullName × Procedure
  const matrix = new Map();     // name -> Map(proc -> sum)
  const grandTotals = new Map();
  let totalCount = 0;

  filtered.forEach(r => {
    const name = r[idx.FullName]||'';
    const proc = r[idx.Procedure]||'';
    const cnt = Number(r[idx.Count]||'0')||0;
    totalCount += cnt;
    if (!matrix.has(name)) matrix.set(name, new Map());
    const row = matrix.get(name);
    row.set(proc, (row.get(proc)||0) + cnt);
    grandTotals.set(proc, (grandTotals.get(proc)||0) + cnt);
  });

  const names = [...matrix.keys()].sort((a,b)=>a.localeCompare(b));

  // ----- Render HTML table (as before) -----
  let html = '<table><thead><tr><th>FullName</th>';
  PROC_ORDER.forEach(p => html += `<th>${escapeHtml(p)}</th>`);
  html += '<th>Total</th></tr></thead><tbody>';

  const colTotals = PROC_ORDER.map(p => grandTotals.get(p)||0);

  const pivotRows = []; // collect rows to export

  names.forEach(name => {
    const row = matrix.get(name);
    let rowTotal = 0;
    const line = [name];
    PROC_ORDER.forEach(p=>{
      const v = row.get(p)||0; rowTotal += v;
      line.push(v);
    });
    line.push(rowTotal);
    pivotRows.push(line);

    html += `<tr><td>${escapeHtml(name)}</td>`;
    PROC_ORDER.forEach(p=> html += `<td>${row.get(p)||0}</td>`);
    html += `<td>${rowTotal}</td></tr>`;
  });

  const grandTotal = colTotals.reduce((a,b)=>a+b,0);
  html += '</tbody><tfoot><tr><td><b>Totals</b></td>';
  colTotals.forEach(v => html += `<td><b>${v}</b></td>`);
  html += `<td><b>${grandTotal}</b></td></tr></tfoot></table>`;

  tableWrap.innerHTML = html;
  statsEl.textContent = `${filtered.length} rows | ${names.length} residents | ${totalCount} total counted procedures`;

  // ----- Keep pivot for download -----
  lastPivot = [
    ['FullName', ...PROC_ORDER, 'Total'],
    ...pivotRows,
    ['Totals', ...colTotals, grandTotal]
  ];
}

  // Simple CSV parser
  function parseCsv(text){
    const rows = [];
    let i = 0, field = '', row = [], inQuotes = false;
    while (i < text.length){
      const ch = text[i++];
      if (inQuotes){
        if (ch === '"'){
          if (text[i] === '"'){ field += '"'; i++; }
          else { inQuotes = false; }
        } else field += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ','){ row.push(field); field=''; }
        else if (ch === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
        else field += ch;
      }
    }
    if (field.length || row.length) { row.push(field); rows.push(row); }
    return rows;
  }

  function escapeHtml(s){ 
    return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
  }
  function csvEscape(v){
  const s = String(v ?? '');
  return (s.includes(',') || s.includes('"') || s.includes('\n'))
    ? '"' + s.replace(/"/g,'""') + '"'
    : s;
}
  function ts() {
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}
function toCsv(arr){           // arr = array-of-arrays
  return arr.map(r => r.map(csvEscape).join(',')).join('\n');
}
function downloadText(text, filename){
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
}
</script>
</body>
</html>
